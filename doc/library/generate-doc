#!/usr/bin/env python

from os import walk
from ansible.utils import plugin_docs as module_docs
from ansible.module_utils.basic import AnsibleModule


def main():

    module = AnsibleModule(
        argument_spec=dict(
            path=dict(required=True),
        ),
        supports_check_mode=False,
    )

    path = module.params['path']
    if path[-1] != '/':
        path = path + '/'

    all_docs = []
    errors = []
    for (dirpath, dirnames, ansible_modules) in walk(path):
        if dirpath == path:
            for mod in ansible_modules:
                try:
                    try:
                        (
                            doc,
                            plainexamples,
                            returndocs,
                        ) = module_docs.get_docstring(path + mod)
                    except ValueError:
                        doc, plainexamples = module_docs.get_docstring(
                            path + mod
                        )
                    except Exception as e:
                        module.fail_json(msg='error', error=str(e))

                    try:
                        examples_list = plainexamples.split('\n')
                        doc['examples'] = examples_list
                    except:
                        errors.append(doc)
                        errors.append('error-examples')
                        continue

                    all_docs.append(doc)
                except:
                    errors.append(mod)
                    errors.append('unknown')
                    continue

    module.exit_json(results=all_docs, errors=errors)


if __name__ == '__main__':
    main()
