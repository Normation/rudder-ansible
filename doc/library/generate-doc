#!/usr/bin/env python

from os import walk

from ansible.module_utils.common.yaml import yaml_load
from ansible.utils.plugin_docs import get_docstring
from ansible.module_utils.basic import AnsibleModule


def main():

    module = AnsibleModule(
        argument_spec=dict(
            path=dict(required=True),
        ),
        supports_check_mode=False,
    )

    path = module.params['path']
    if path[-1] != '/':
        path = path + '/'

    all_docs = []
    errors = []
    for (dirpath, dirnames, ansible_modules) in walk(path):
        if dirpath == path:
            for mod in ansible_modules:
                try:
                    try:
                        (doc, plainexamples, returndocs,) = get_docstring(
                            filename=path + mod,
                            fragment_loader=fragment_loader,
                            verbose=True,
                        )
                    except ValueError:
                        doc, plainexamples = get_docstring(
                            filenmae=path + mod,
                            fragment_loader=fragment_loader,
                            verbose=True,
                        )
                    except Exception as err:
                        module.fail_json(msg='error', error=str(err))

                    try:
                        examples_list = plainexamples.split('\n')
                        doc['examples'] = examples_list
                    except:
                        errors.append(doc)
                        errors.append('error-examples')
                        continue

                    all_docs.append(doc)
                except:
                    errors.append(mod)
                    errors.append('unknown')
                    continue

    module.exit_json(results=all_docs, errors=errors)


if __name__ == '__main__':
    main()
